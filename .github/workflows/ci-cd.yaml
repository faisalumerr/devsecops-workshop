name: Build-Scan-Push-Deploy (Self-Hosted Runner)

on:
  push:
    branches: [ main ]

jobs:
  pipeline:
    runs-on: self-hosted

    steps:
    # ------------------
    # CHECKOUT CODE
    # ------------------
    - uses: actions/checkout@v4

    # ------------------
    # BUILD IMAGE
    # ------------------
    - name: Build Docker image
      run: |
        docker build --no-cache \
          -t ghcr.io/${{ github.repository_owner }}/devsecops-app:v1.2.1 \
          -f app/Dockerfile \
          app/

    # ------------------
    # SCAN IMAGE
    # ------------------
    - name: Scan image with Trivy
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: ghcr.io/${{ github.repository_owner }}/devsecops-app:v1.2.1
        severity: CRITICAL,HIGH
        ignore-unfixed: true
        exit-code: '0'

    # ------------------
    # LOGIN + PUSH TO GHCR
    # ------------------
    - name: Login to GHCR
      run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Push image
      run: docker push ghcr.io/${{ github.repository_owner }}/devsecops-app:v1.2.1

    # ------------------
    # INSTALL KUBECTL
    # ------------------
    - name: Install kubectl
      uses: azure/setup-kubectl@v3

    # ------------------
    # CREATE GHCR PULL SECRET
    # ------------------
    - name: Create GHCR pull secret in Minikube
      run: |
        kubectl delete secret ghcr-secret --ignore-not-found=true
        kubectl create secret docker-registry ghcr-secret \
          --docker-server=ghcr.io \
          --docker-username=faisalumerr \
          --docker-password=${{ secrets.GHCR_PAT }} \
          --docker-email=dummy@example.com

    # ------------------
    # APPLY K8S MANIFESTS
    # ------------------
    - name: Deploy manifests
      run: kubectl apply -f k8s/

    # ------------------
    # PATCH DEPLOYMENT (AFTER applying manifests)
    # ------------------
    - name: Patch deployment with imagePullSecret
      run: |
        kubectl patch deployment devsecops-app \
          -p '{"spec":{"template":{"spec":{"imagePullSecrets":[{"name":"ghcr-secret"}]}}}}'

    # ------------------
    # WAIT FOR ROLLOUT
    # ------------------
    - name: Wait for rollout
      run: kubectl rollout status deployment/devsecops-app
