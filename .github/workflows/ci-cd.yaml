name: Build-Scan-Push-Deploy (Self-Hosted Runner)

on:
  push:
    branches: [ main ]

jobs:
  pipeline:
    runs-on: self-hosted

    steps:
    # ------------------
    # CHECKOUT CODE
    # ------------------
    - uses: actions/checkout@v4

    # ------------------
    # BUILD IMAGE
    # ------------------
    - name: Build Docker image
      run: |
        docker build \
          -t ghcr.io/${{ github.repository_owner }}/devsecops-app:latest \
          -f app/Dockerfile \
          app/

    # ------------------
    # SCAN IMAGE
    # ------------------
    - name: Scan image with Trivy
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: ghcr.io/${{ github.repository_owner }}/devsecops-app:latest
        severity: CRITICAL,HIGH
        ignore-unfixed: true
        exit-code: '0'

    # ------------------
    # LOGIN + PUSH TO GHCR
    # ------------------
    - name: Login to GHCR
      run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Push image
      run: docker push ghcr.io/${{ github.repository_owner }}/devsecops-app:latest

    # ------------------
    # INSTALL KUBECTL
    # ------------------
    - name: Install kubectl
      uses: azure/setup-kubectl@v3

    # ------------------
    # CREATE GHCR PULL SECRET IN MINIKUBE
    # ------------------
    - name: Create GHCR pull secret in Minikube
      run: |
        kubectl delete secret ghcr-secret --ignore-not-found=true
        kubectl create secret docker-registry ghcr-secret \
          --docker-server=ghcr.io \
          --docker-username=faisalumerr \
          --docker-password=${{ secrets.GHCR_PAT }} \
          --docker-email=faisal@example.com

    # ------------------
    # PATCH DEPLOYMENT TO USE IMAGEPULLSECRET
    # ------------------
    - name: Patch deployment with pull secret
      run: |
        kubectl patch deployment devsecops-app \
          -p '{"spec":{"template":{"spec":{"imagePullSecrets":[{"name":"ghcr-secret"}]}}}}' || true

    # ------------------
    # DEPLOY TO MINIKUBE
    # ------------------
    - name: Deploy to Minikube
      run: kubectl apply -f k8s/

    # ------------------
    # WAIT FOR ROLLOUT
    # ------------------
    - name: Wait for rollout
      run: kubectl rollout status deployment/devsecops-app
